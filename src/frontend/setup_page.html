<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Proxy Negotiator - 設定頁</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <h1>Voice Proxy Negotiator</h1>
    <h2>對話設定</h2>

    <form id="setupForm">
        <!-- Agent Identity Section -->
        <div class="card" style="margin-bottom: 20px; background: #1a2744;">
            <h3 style="margin-top: 0; color: #00d4ff;">你的身份 (Your Identity)</h3>

            <div class="form-group">
                <label for="agentName">
                    你的名字 (Your Name)
                    <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="agentName"
                    name="agentName"
                    placeholder="例如：Adam Chan"
                    value="Adam Chan"
                    maxlength="50"
                    required
                >
                <div class="text-muted mt-10" style="font-size: 0.85rem;">
                    AI 代理會以你的名字與對方對話
                </div>
            </div>

            <div class="form-group">
                <label for="counterpartType">
                    對方是誰 (Who are you speaking with?)
                </label>
                <input
                    type="text"
                    id="counterpartType"
                    name="counterpartType"
                    placeholder="例如：customer service / 房東 / 供應商"
                    maxlength="100"
                >
                <div class="text-muted mt-10" style="font-size: 0.85rem;">
                    AI 會知道對話對象的身份
                </div>
            </div>

            <div class="form-group">
                <label for="taskLanguage">
                    任務語言 (Conversation Language)
                    <span class="required">*</span>
                </label>
                <select id="taskLanguage" name="taskLanguage" required>
                    <option value="zh-TW">繁體中文 (Traditional Chinese)</option>
                    <option value="zh-CN">简体中文 (Simplified Chinese)</option>
                    <option value="en">English</option>
                    <option value="ja">日本語 (Japanese)</option>
                    <option value="ko">한국어 (Korean)</option>
                </select>
                <div class="text-muted mt-10" style="font-size: 0.85rem;">
                    AI 代理將全程使用此語言對話
                </div>
            </div>

            <!-- Hidden fields for backward compatibility -->
            <input type="hidden" id="agentRole" name="agentRole" value="">
            <input type="hidden" id="companyName" name="companyName" value="">
        </div>

        <!-- Goal (Required) -->
        <div class="form-group">
            <label for="goal">
                任務目標 (Goal Statement)
                <span class="required">*</span>
            </label>
            <textarea
                id="goal"
                name="goal"
                class="large"
                placeholder="例如：與房東協商降低租金 10%，並延長租約期限至兩年"
                maxlength="1000"
                required
            ></textarea>
            <div class="char-counter">
                <span class="count" id="goalCount">0 / 1000</span>
                <span class="token-estimate" id="goalTokens">~0 tokens</span>
            </div>
        </div>

        <!-- Rules (Optional) -->
        <div class="form-group">
            <label for="rules">
                規則/禁區 (Rules / Constraints)
            </label>
            <textarea
                id="rules"
                name="rules"
                placeholder="例如：不可透露最高預算；不可承諾超過 24 個月的租約"
                maxlength="2000"
            ></textarea>
            <div class="char-counter">
                <span class="count" id="rulesCount">0 / 2000</span>
                <span class="token-estimate" id="rulesTokens">~0 tokens</span>
            </div>
        </div>

        <!-- SSOT (Optional, with 5000 char limit) -->
        <div class="form-group">
            <label for="ssot">
                參考資料 (SSOT)
            </label>
            <textarea
                id="ssot"
                name="ssot"
                class="large"
                placeholder="貼上相關資料（合約條款、產品規格、歷史紀錄等）"
                maxlength="5500"
            ></textarea>
            <div class="char-counter">
                <span class="count" id="ssotCount">0 / 5000</span>
                <span class="token-estimate" id="ssotTokens">~0 tokens</span>
            </div>
            <div class="error-message" id="ssotError">
                SSOT 超過 5000 字元限制，請精簡內容或在開始對話時系統會自動摘要
            </div>
        </div>

        <!-- Stop Conditions (Optional) -->
        <div class="form-group">
            <label for="stopConditions">
                停止條件 (Stop Conditions)
            </label>
            <textarea
                id="stopConditions"
                name="stopConditions"
                placeholder="例如：對方同意降價 8% 以上即可達標；如對方拒絕協商則禮貌結束"
            ></textarea>
            <div class="char-counter">
                <span class="count" id="stopConditionsCount">0</span>
                <span class="token-estimate" id="stopConditionsTokens">~0 tokens</span>
            </div>
        </div>

        <!-- Voice Selection -->
        <div class="form-group">
            <label for="voice">
                語音角色 (Voice)
            </label>
            <select id="voice" name="voice">
                <option value="marin">Marin (Female)</option>
                <option value="cedar">Cedar (Male)</option>
            </select>
        </div>

        <!-- Button Configuration Section -->
        <div class="card" style="margin-bottom: 20px; background: #1a2744;">
            <h3 style="margin-top: 0; color: #00d4ff;">即時指令按鈕設定</h3>

            <!-- Simple Mode Toggle -->
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="advancedModeToggle" style="margin-right: 10px; width: auto;">
                    <span>進階模式（自定義按鈕配置）</span>
                </label>
                <div class="text-muted mt-10" style="font-size: 0.85rem;">
                    預設使用標準按鈕配置，勾選後可自定義每個按鈕的行為
                </div>
            </div>

            <!-- Button Preview (Simple Mode) -->
            <div id="buttonPreview">
                <div class="text-muted" style="margin-bottom: 10px;">預覽：</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <span class="btn-preview btn-secondary">同意</span>
                    <span class="btn-preview btn-secondary">不同意</span>
                    <span class="btn-preview btn-secondary">我需要時間考慮</span>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                    <span class="btn-preview btn-secondary">請重複一次</span>
                    <span class="btn-preview btn-secondary">提出替代方案</span>
                    <span class="btn-preview btn-secondary">詢問對方底線</span>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                    <span class="btn-preview btn-warning">是時候說再見</span>
                    <span class="btn-preview btn-goal-met">達標</span>
                    <span class="btn-preview btn-emergency">立即停止</span>
                </div>
            </div>

            <!-- Advanced Mode Configuration -->
            <div id="advancedConfig" style="display: none;">
                <div class="text-muted" style="margin-bottom: 15px; font-size: 0.85rem;">
                    可用變數：<code>{{goal}}</code> <code>{{lastCounterpart}}</code> <code>{{lastAI}}</code> <code>{{agentName}}</code> <code>{{counterpartType}}</code>
                </div>

                <!-- Button Config Container -->
                <div id="buttonConfigContainer"></div>

                <!-- Reset Button -->
                <div style="margin-top: 15px;">
                    <button type="button" id="resetButtonConfig" class="btn-secondary" style="padding: 8px 16px;">
                        重置為預設
                    </button>
                </div>
            </div>
        </div>

        <!-- Total Token Estimate -->
        <div class="card">
            <div class="flex-between">
                <span>預估總 Token 數</span>
                <span id="totalTokens" class="text-muted">~0 tokens</span>
            </div>
            <div class="text-muted mt-10" style="font-size: 0.85rem;">
                建議總量不超過 3000 tokens 以保留對話空間
            </div>
        </div>

        <!-- Submit Button -->
        <div class="text-center mt-20">
            <button type="submit" class="btn-primary btn-large" id="startBtn">
                開始對話
            </button>
        </div>
    </form>

    <script>
        // ============================================
        // Token Estimation (Simplified)
        // Chinese: ~2 tokens per character
        // English: ~1.3 tokens per word
        // ============================================
        function estimateTokens(text) {
            if (!text) return 0;

            // Separate Chinese and non-Chinese characters
            const chineseChars = (text.match(/[\u4e00-\u9fff]/g) || []).length;
            const nonChinese = text.replace(/[\u4e00-\u9fff]/g, '');
            const englishWords = nonChinese.trim().split(/\s+/).filter(w => w.length > 0).length;

            // Estimate: Chinese * 2 + English words * 1.3
            return Math.ceil(chineseChars * 2 + englishWords * 1.3);
        }

        // ============================================
        // Character Counter & Token Estimator
        // ============================================
        function updateCounter(textareaId, counterId, tokenId, maxLength) {
            const textarea = document.getElementById(textareaId);
            const counter = document.getElementById(counterId);
            const tokenEl = document.getElementById(tokenId);

            const length = textarea.value.length;
            const tokens = estimateTokens(textarea.value);

            // Update character count
            if (maxLength) {
                counter.textContent = `${length} / ${maxLength}`;
            } else {
                counter.textContent = length;
            }

            // Update token estimate
            tokenEl.textContent = `~${tokens} tokens`;

            // Add warning/error classes based on length
            counter.classList.remove('warning', 'error');
            if (maxLength) {
                if (length > maxLength) {
                    counter.classList.add('error');
                } else if (length > maxLength * 0.9) {
                    counter.classList.add('warning');
                }
            }

            return tokens;
        }

        // SSOT special handling (5000 char limit)
        function updateSSOTCounter() {
            const ssot = document.getElementById('ssot');
            const counter = document.getElementById('ssotCount');
            const tokenEl = document.getElementById('ssotTokens');
            const errorEl = document.getElementById('ssotError');

            const length = ssot.value.length;
            const tokens = estimateTokens(ssot.value);

            counter.textContent = `${length} / 5000`;
            tokenEl.textContent = `~${tokens} tokens`;

            counter.classList.remove('warning', 'error');
            errorEl.classList.remove('visible');

            if (length > 5000) {
                counter.classList.add('error');
                errorEl.classList.add('visible');
            } else if (length > 4500) {
                counter.classList.add('warning');
            }

            return tokens;
        }

        // Update total tokens
        function updateTotalTokens() {
            const goalTokens = estimateTokens(document.getElementById('goal').value);
            const rulesTokens = estimateTokens(document.getElementById('rules').value);
            const ssotTokens = estimateTokens(document.getElementById('ssot').value);
            const stopConditionsTokens = estimateTokens(document.getElementById('stopConditions').value);

            const total = goalTokens + rulesTokens + ssotTokens + stopConditionsTokens;
            document.getElementById('totalTokens').textContent = `~${total} tokens`;

            // Update individual displays
            document.getElementById('goalTokens').textContent = `~${goalTokens} tokens`;
            document.getElementById('rulesTokens').textContent = `~${rulesTokens} tokens`;
            document.getElementById('ssotTokens').textContent = `~${ssotTokens} tokens`;
            document.getElementById('stopConditionsTokens').textContent = `~${stopConditionsTokens} tokens`;
        }

        // ============================================
        // Event Listeners
        // ============================================
        document.getElementById('goal').addEventListener('input', () => {
            updateCounter('goal', 'goalCount', 'goalTokens', 1000);
            updateTotalTokens();
        });

        document.getElementById('rules').addEventListener('input', () => {
            updateCounter('rules', 'rulesCount', 'rulesTokens', 2000);
            updateTotalTokens();
        });

        document.getElementById('ssot').addEventListener('input', () => {
            updateSSOTCounter();
            updateTotalTokens();
        });

        document.getElementById('stopConditions').addEventListener('input', () => {
            updateCounter('stopConditions', 'stopConditionsCount', 'stopConditionsTokens', null);
            updateTotalTokens();
        });

        // ============================================
        // Button Configuration System
        // ============================================

        // Default button configuration (from design doc § 2.4)
        // IMPORTANT: Must match app.js DEFAULT_BUTTONS with [INTERNAL GUIDANCE] prefix
        const DEFAULT_BUTTONS = [
            // Row 1: Position expression
            {
                id: "btn_agree",
                label: "同意",
                executionType: "continue",
                promptTemplate: "Express agreement with the counterpart's point.",
                guidanceTemplate: `[INTERNAL GUIDANCE - NOT FROM THE OTHER PARTY]
Your principal wants you to EXPRESS AGREEMENT with what the other party just said.
- React naturally to their specific point
- Show genuine understanding of WHY you agree
- Be warm and positive, but don't overdo it
- Remember: YOU speak FOR your principal, TO the other party`,
                buttonClass: "btn-secondary"
            },
            {
                id: "btn_disagree",
                label: "不同意",
                executionType: "continue",
                promptTemplate: "Express disagreement politely but firmly.",
                guidanceTemplate: `[INTERNAL GUIDANCE - NOT FROM THE OTHER PARTY]
Your principal wants you to DISAGREE with what the other party said.
- First show you understand their position (don't dismiss)
- Then express your disagreement with reasoning
- Be firm but respectful - this is a negotiation, not a fight
- Remember: YOU speak FOR your principal, TO the other party`,
                buttonClass: "btn-secondary"
            },
            {
                id: "btn_need_time",
                label: "我需要時間考慮",
                executionType: "continue",
                promptTemplate: "Request time to think before committing.",
                guidanceTemplate: `[INTERNAL GUIDANCE - NOT FROM THE OTHER PARTY]
Your principal needs TIME before deciding.
- Tell the other party you need time to think
- Don't reject or accept - just defer
- Give a natural reason (need to review, consult, think it over)
- Remember: YOU represent your principal in this conversation`,
                buttonClass: "btn-secondary"
            },
            // Row 2: Information gathering
            {
                id: "btn_repeat",
                label: "請重複一次",
                executionType: "continue",
                promptTemplate: "Ask them to repeat or clarify.",
                guidanceTemplate: `[INTERNAL GUIDANCE - NOT FROM THE OTHER PARTY]
Your principal needs the other party to REPEAT or CLARIFY what they said.
- Ask naturally - maybe you missed something, or want more detail
- Be specific if possible about what part needs clarification
- Remember: YOU are asking the other party on behalf of your principal`,
                buttonClass: "btn-secondary"
            },
            {
                id: "btn_propose",
                label: "提出替代方案",
                executionType: "continue",
                promptTemplate: "Suggest an alternative approach.",
                guidanceTemplate: `[INTERNAL GUIDANCE - NOT FROM THE OTHER PARTY]
Your principal wants to PROPOSE SOMETHING DIFFERENT to the other party.
- Acknowledge their offer first
- Then pivot to your alternative idea
- Frame it as a win-win if possible
- Remember: YOU are negotiating WITH the other party FOR your principal`,
                buttonClass: "btn-secondary"
            },
            {
                id: "btn_ask_bottom",
                label: "詢問對方底線",
                executionType: "continue",
                promptTemplate: "Probe for their minimum acceptable terms.",
                guidanceTemplate: `[INTERNAL GUIDANCE - NOT FROM THE OTHER PARTY]
Your principal wants to know the other party's BOTTOM LINE.
- Ask tactfully - don't demand
- Frame it as wanting to understand what's possible
- You might ask about flexibility, limits, must-haves
- Remember: YOU are probing the other party on behalf of your principal`,
                buttonClass: "btn-secondary"
            },
            // Row 3: End controls
            {
                id: "btn_goodbye",
                label: "是時候說再見",
                executionType: "natural_end",
                promptTemplate: "End the conversation gracefully.",
                guidanceTemplate: `[INTERNAL GUIDANCE - NOT FROM THE OTHER PARTY]
Your principal wants to END this conversation now.
- Wrap up naturally - don't just suddenly say goodbye
- Respond briefly to whatever they just said
- Signal you need to go (in your own words)
- Thank them warmly and say goodbye
- Make it feel like a natural ending, not an abrupt cutoff`,
                buttonClass: "btn-warning"
            },
            {
                id: "btn_goal_met",
                label: "達標",
                executionType: "natural_end",
                promptTemplate: "Goal achieved! Wrap up positively.",
                guidanceTemplate: `[INTERNAL GUIDANCE - NOT FROM THE OTHER PARTY]
SUCCESS! The goal has been achieved. End on a HIGH NOTE.
- Express genuine satisfaction/gratitude
- Acknowledge what was accomplished
- Wrap up warmly and positively
- Say goodbye with enthusiasm
- This is a celebration - sound happy!`,
                buttonClass: "btn-goal-met"
            },
            {
                id: "btn_emergency",
                label: "立即停止",
                executionType: "emergency",
                promptTemplate: null,
                guidanceTemplate: null,
                buttonClass: "btn-emergency"
            }
        ];

        // Execution type options
        const EXECUTION_TYPES = [
            { value: "continue", label: "繼續對話", desc: "呼叫 Controller → 注入指令 → 對話繼續" },
            { value: "natural_end", label: "自然結束", desc: "呼叫 Controller → 自然過渡 → 說再見 → 斷線" },
            { value: "immediate_end", label: "立即結束", desc: "呼叫 Controller → 打斷當前 → 快速再見 → 斷線" },
            { value: "emergency", label: "緊急停止", desc: "無 API 呼叫 → 立即斷線" },
            { value: "inject_only", label: "僅注入指令", desc: "不呼叫 Controller → 直接注入 prompt" }
        ];

        // Button style options
        const BUTTON_STYLES = [
            { value: "btn-secondary", label: "標準 (灰色)" },
            { value: "btn-warning", label: "警告 (橙色)" },
            { value: "btn-goal-met", label: "達標 (綠色)" },
            { value: "btn-emergency", label: "緊急 (紅色)" },
            { value: "btn-primary", label: "主要 (藍色)" }
        ];

        // Current button config (will be modified in advanced mode)
        let currentButtonConfig = JSON.parse(JSON.stringify(DEFAULT_BUTTONS));

        // Render a single button config card
        function renderButtonConfigCard(btn, index) {
            const isEmergency = btn.executionType === 'emergency';
            return `
                <div class="button-config-card" data-index="${index}">
                    <div class="btn-header">
                        <span class="btn-label">${btn.label}</span>
                        <span class="text-muted" style="font-size: 0.8rem;">${btn.id}</span>
                    </div>

                    <div class="form-row">
                        <label>顯示文字</label>
                        <input type="text" class="btn-label-input" value="${btn.label}" data-field="label">
                    </div>

                    <div class="form-row">
                        <label>執行類型</label>
                        <select class="btn-exec-type" data-field="executionType">
                            ${EXECUTION_TYPES.map(t => `
                                <option value="${t.value}" ${btn.executionType === t.value ? 'selected' : ''}>
                                    ${t.label}
                                </option>
                            `).join('')}
                        </select>
                    </div>

                    <div class="form-row prompt-row" ${isEmergency ? 'style="display:none;"' : ''}>
                        <label>Prompt 模板</label>
                        <textarea class="btn-prompt" data-field="promptTemplate" rows="2">${btn.promptTemplate || ''}</textarea>
                    </div>

                    <div class="form-row guidance-row" ${isEmergency ? 'style="display:none;"' : ''}>
                        <label>Guidance 模板</label>
                        <textarea class="btn-guidance" data-field="guidanceTemplate" rows="4">${btn.guidanceTemplate || ''}</textarea>
                    </div>

                    <div class="form-row">
                        <label>按鈕樣式</label>
                        <select class="btn-style style-select" data-field="buttonClass">
                            ${BUTTON_STYLES.map(s => `
                                <option value="${s.value}" ${btn.buttonClass === s.value ? 'selected' : ''}>
                                    ${s.label}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                </div>
            `;
        }

        // Render all button config cards
        function renderAllButtonConfigs() {
            const container = document.getElementById('buttonConfigContainer');
            container.innerHTML = currentButtonConfig.map((btn, i) => renderButtonConfigCard(btn, i)).join('');

            // Add event listeners for each input
            container.querySelectorAll('.button-config-card').forEach((card, index) => {
                // Text inputs and textareas
                card.querySelectorAll('input[type="text"], textarea').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const field = e.target.dataset.field;
                        currentButtonConfig[index][field] = e.target.value;
                    });
                });

                // Selects
                card.querySelectorAll('select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const field = e.target.dataset.field;
                        currentButtonConfig[index][field] = e.target.value;

                        // Show/hide prompt fields based on execution type
                        if (field === 'executionType') {
                            const isEmergency = e.target.value === 'emergency';
                            card.querySelector('.prompt-row').style.display = isEmergency ? 'none' : 'grid';
                            card.querySelector('.guidance-row').style.display = isEmergency ? 'none' : 'grid';
                        }
                    });
                });
            });
        }

        // Toggle advanced mode
        document.getElementById('advancedModeToggle').addEventListener('change', (e) => {
            const isAdvanced = e.target.checked;
            document.getElementById('buttonPreview').style.display = isAdvanced ? 'none' : 'block';
            document.getElementById('advancedConfig').style.display = isAdvanced ? 'block' : 'none';

            if (isAdvanced) {
                renderAllButtonConfigs();
            }
        });

        // Reset to default
        document.getElementById('resetButtonConfig').addEventListener('click', () => {
            if (confirm('確定要重置為預設配置嗎？')) {
                currentButtonConfig = JSON.parse(JSON.stringify(DEFAULT_BUTTONS));
                renderAllButtonConfigs();
            }
        });

        // ============================================
        // Form Submission
        // ============================================
        document.getElementById('setupForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // Agent identity fields
            const agentName = document.getElementById('agentName').value.trim();
            const agentRole = document.getElementById('agentRole').value.trim();
            const companyName = document.getElementById('companyName').value.trim();
            const counterpartType = document.getElementById('counterpartType').value.trim();

            // Other fields
            const goal = document.getElementById('goal').value.trim();
            const rules = document.getElementById('rules').value.trim();
            const ssot = document.getElementById('ssot').value.trim();
            const stopConditions = document.getElementById('stopConditions').value.trim();
            const voice = document.getElementById('voice').value;
            const taskLanguage = document.getElementById('taskLanguage').value;

            // Validation: Agent Name is required
            if (!agentName) {
                alert('請填寫代理名稱');
                document.getElementById('agentName').focus();
                return;
            }

            // Validation: Goal is required
            if (!goal) {
                alert('請填寫任務目標');
                document.getElementById('goal').focus();
                return;
            }

            // Validation: Goal max 1000 chars
            if (goal.length > 1000) {
                alert('任務目標不可超過 1000 字元');
                document.getElementById('goal').focus();
                return;
            }

            // Validation: Rules max 2000 chars
            if (rules.length > 2000) {
                alert('規則不可超過 2000 字元');
                document.getElementById('rules').focus();
                return;
            }

            // Warning: SSOT > 5000 (but allow proceed)
            if (ssot.length > 5000) {
                const proceed = confirm('SSOT 超過 5000 字元，系統將在開始對話時自動摘要。是否繼續？');
                if (!proceed) {
                    document.getElementById('ssot').focus();
                    return;
                }
            }

            // Determine which button config to use
            const isAdvancedMode = document.getElementById('advancedModeToggle').checked;
            const buttonConfigToUse = isAdvancedMode ? currentButtonConfig : DEFAULT_BUTTONS;

            // Build config object
            const config = {
                // Agent identity
                agentName: agentName,
                agentRole: agentRole || 'representative',
                companyName: companyName || 'our company',
                counterpartType: counterpartType || 'the other party',
                taskLanguage: taskLanguage,
                // Negotiation settings
                goal: goal,
                rules: rules,
                ssot: ssot,
                stopConditions: stopConditions,
                voice: voice,
                // Button configuration
                advancedMode: isAdvancedMode,
                buttonMapping: {
                    "同意": "AGREE",
                    "不同意": "DISAGREE",
                    "我需要時間考慮": "NEED_TIME",
                    "請重複一次": "REPEAT",
                    "提出替代方案": "PROPOSE_ALTERNATIVE",
                    "詢問對方底線": "ASK_BOTTOM_LINE",
                    "是時候說再見": "SAY_GOODBYE",
                    "達標": "GOAL_MET",
                    "立即停止": "EMERGENCY_STOP"
                }
            };

            // Save main config to localStorage
            localStorage.setItem('vpn_config', JSON.stringify(config));

            // Save button config separately (for conversation page to use)
            localStorage.setItem('vpn_button_config', JSON.stringify(buttonConfigToUse));

            console.log('Config saved to localStorage:', config);
            console.log('Button config saved:', buttonConfigToUse);

            // Navigate to conversation page
            window.location.href = '/conversation';
        });

        // ============================================
        // Initialize
        // ============================================
        // Check if returning from conversation page with saved config
        const savedConfig = localStorage.getItem('vpn_config');
        if (savedConfig) {
            try {
                const config = JSON.parse(savedConfig);
                // Restore agent identity
                document.getElementById('agentName').value = config.agentName || '';
                document.getElementById('agentRole').value = config.agentRole || '';
                document.getElementById('companyName').value = config.companyName || '';
                document.getElementById('counterpartType').value = config.counterpartType || '';
                document.getElementById('taskLanguage').value = config.taskLanguage || 'zh-TW';
                // Restore other fields
                document.getElementById('goal').value = config.goal || '';
                document.getElementById('rules').value = config.rules || '';
                document.getElementById('ssot').value = config.ssot || '';
                document.getElementById('stopConditions').value = config.stopConditions || '';
                document.getElementById('voice').value = config.voice || 'marin';

                // Update all counters
                updateCounter('goal', 'goalCount', 'goalTokens', 1000);
                updateCounter('rules', 'rulesCount', 'rulesTokens', 2000);
                updateSSOTCounter();
                updateCounter('stopConditions', 'stopConditionsCount', 'stopConditionsTokens', null);
                updateTotalTokens();

                // Restore advanced mode state
                if (config.advancedMode) {
                    document.getElementById('advancedModeToggle').checked = true;
                    document.getElementById('buttonPreview').style.display = 'none';
                    document.getElementById('advancedConfig').style.display = 'block';
                }
            } catch (e) {
                console.error('Failed to restore config:', e);
            }
        }

        // Restore button config if exists
        const savedButtonConfig = localStorage.getItem('vpn_button_config');
        if (savedButtonConfig) {
            try {
                currentButtonConfig = JSON.parse(savedButtonConfig);
                // Render if advanced mode is active
                if (document.getElementById('advancedModeToggle').checked) {
                    renderAllButtonConfigs();
                }
            } catch (e) {
                console.error('Failed to restore button config:', e);
            }
        }

        console.log('Setup page loaded');
    </script>
</body>
</html>
