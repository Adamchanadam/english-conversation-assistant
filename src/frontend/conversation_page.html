<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Proxy Negotiator - 對話中</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <h1>Voice Proxy Negotiator</h1>

    <!-- Connection Status -->
    <div id="connectionStatus" class="status disconnected">
        <div class="flex-between">
            <div>
                <strong>連線狀態：</strong>
                <span id="statusText">未連線</span>
            </div>
            <div>
                <strong>目前狀態：</strong>
                <span id="stateText">INIT</span>
            </div>
        </div>
        <!-- Session Timer Progress Bar -->
        <div id="timerContainer" class="timer-container" style="display: none;">
            <div class="timer-header">
                <span>對話時長</span>
                <span id="sessionTimer">00:00</span>
                <span class="text-muted">/ 45:00</span>
            </div>
            <div class="timer-progress-bar">
                <div id="timerProgress" class="timer-progress" style="width: 0%;"></div>
            </div>
        </div>
    </div>

    <!-- Session Timer Notification (non-intrusive toast) -->
    <div id="timerNotification" class="timer-notification hidden">
        <span id="timerNotificationText"></span>
        <button onclick="dismissNotification()" class="notification-dismiss">✕</button>
    </div>

    <!-- Audio Status -->
    <div class="status">
        <div class="flex-between">
            <div>
                <span class="audio-indicator inactive" id="micIndicator"></span>
                <strong>麥克風：</strong>
                <span id="micStatus">未啟用</span>
            </div>
            <div>
                <span class="audio-indicator inactive" id="speakerIndicator"></span>
                <strong>播放：</strong>
                <span id="speakerStatus">未播放</span>
            </div>
        </div>
    </div>

    <!-- Goal Display -->
    <div class="card">
        <div class="card-header">
            <strong>任務目標</strong>
        </div>
        <div id="goalDisplay" class="text-muted">
            （載入中...）
        </div>
    </div>

    <!-- Button Grid (3x3) - Dynamically rendered -->
    <h3>即時指令</h3>
    <div class="button-grid" id="buttonGrid">
        <!-- Buttons will be dynamically generated from configuration -->
    </div>

    <!-- Control Buttons -->
    <div class="text-center mt-20">
        <button id="btnConnect" class="btn-primary" onclick="handleConnect()">
            連線開始對話
        </button>
        <button id="btnDisconnect" class="btn-danger" onclick="handleDisconnect()" disabled>
            斷線
        </button>
        <button id="btnBackToSetup" class="btn-secondary" onclick="backToSetup()">
            返回設定
        </button>
    </div>

    <!-- Event Log -->
    <h3 class="mt-20">事件日誌</h3>
    <div class="event-log" id="log"></div>
    <div class="text-center mt-10">
        <button class="btn-secondary" onclick="clearLog()" style="padding: 8px 16px; font-size: 0.9rem;">
            清除日誌
        </button>
    </div>

    <!-- Include state machine and app modules -->
    <script src="/static/state_machine.js"></script>
    <script src="/static/app.js"></script>
    <script>
        // ============================================
        // Voice Proxy Negotiator - Conversation Page
        // Integration with VoiceProxyApp (app.js)
        // ============================================

        // Application instance
        let app = null;

        // DOM Elements
        const logEl = document.getElementById('log');
        const statusEl = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');
        const stateText = document.getElementById('stateText');
        const micIndicator = document.getElementById('micIndicator');
        const speakerIndicator = document.getElementById('speakerIndicator');
        const micStatus = document.getElementById('micStatus');
        const speakerStatus = document.getElementById('speakerStatus');
        const goalDisplay = document.getElementById('goalDisplay');
        const btnConnect = document.getElementById('btnConnect');
        const btnDisconnect = document.getElementById('btnDisconnect');

        // Notes display element (create if not exists)
        let notesDisplay = document.getElementById('notesDisplay');
        if (!notesDisplay) {
            notesDisplay = document.createElement('div');
            notesDisplay.id = 'notesDisplay';
            notesDisplay.className = 'card';
            notesDisplay.style.display = 'none';
            notesDisplay.innerHTML = '<div class="card-header"><strong>系統提示</strong></div><div id="notesContent"></div>';
            document.getElementById('goalDisplay').parentElement.after(notesDisplay);
        }

        // ============================================
        // UI Update Functions
        // ============================================

        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString('zh-TW');
            const line = document.createElement('div');
            line.className = `log-${type}`;
            line.textContent = `[${time}] ${msg}`;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            logEl.innerHTML = '';
            log('日誌已清除', 'info');
        }

        function updateConnectionStatus(status, text) {
            statusEl.className = `status ${status}`;
            statusText.textContent = text;

            // Update button states
            if (status === 'connected') {
                btnConnect.disabled = true;
                btnDisconnect.disabled = false;
            } else if (status === 'disconnected') {
                btnConnect.disabled = false;
                btnDisconnect.disabled = true;
            } else if (status === 'connecting') {
                btnConnect.disabled = true;
                btnDisconnect.disabled = true;
            }
        }

        function updateState(oldState, newState) {
            stateText.textContent = newState;

            // Update button grid based on state
            const buttonGrid = document.getElementById('buttonGrid');
            if (newState === 'STOPPED' || newState === 'STOPPING') {
                buttonGrid.classList.add('disabled');
            } else {
                buttonGrid.classList.remove('disabled');
            }
        }

        function updateMicStatus(active) {
            micIndicator.className = `audio-indicator ${active ? 'active' : 'inactive'}`;
            micStatus.textContent = active ? '正在收音' : '靜音';
        }

        function updateSpeakerStatus(active) {
            speakerIndicator.className = `audio-indicator ${active ? 'active' : 'inactive'}`;
            speakerStatus.textContent = active ? '正在播放' : '靜音';
        }

        function showNotesForUser(notes) {
            if (notes) {
                notesDisplay.style.display = 'block';
                document.getElementById('notesContent').textContent = notes;
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    notesDisplay.style.display = 'none';
                }, 10000);
            }
        }

        // ============================================
        // Session Timer Functions
        // ============================================

        const sessionTimerEl = document.getElementById('sessionTimer');
        const timerContainerEl = document.getElementById('timerContainer');
        const timerProgressEl = document.getElementById('timerProgress');
        const timerNotificationEl = document.getElementById('timerNotification');
        const timerNotificationText = document.getElementById('timerNotificationText');
        const maxSessionSeconds = 45 * 60;  // 45 minutes

        function updateSessionTimer(elapsedSeconds) {
            // Show timer container when session starts
            timerContainerEl.style.display = 'block';

            const mins = Math.floor(elapsedSeconds / 60);
            const secs = elapsedSeconds % 60;
            sessionTimerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            // Update progress bar
            const progressPercent = Math.min((elapsedSeconds / maxSessionSeconds) * 100, 100);
            timerProgressEl.style.width = `${progressPercent}%`;

            // Update colors based on remaining time
            const remainingMins = 45 - mins;
            if (remainingMins <= 3) {
                // < 3 minutes: RED flashing
                timerProgressEl.className = 'timer-progress critical';
                sessionTimerEl.style.color = '#ff4444';
            } else if (remainingMins <= 5) {
                // 3-5 minutes: ORANGE
                timerProgressEl.className = 'timer-progress warning';
                sessionTimerEl.style.color = '#ffaa00';
            } else if (remainingMins <= 10) {
                // 5-10 minutes: LIGHT BLUE (distinct from cyan)
                timerProgressEl.className = 'timer-progress caution';
                sessionTimerEl.style.color = '#66b3ff';
            } else {
                // > 10 minutes: CYAN
                timerProgressEl.className = 'timer-progress';
                sessionTimerEl.style.color = '#00d4ff';
            }
        }

        function showTimerNotification(message, type = 'info') {
            timerNotificationText.textContent = message;
            timerNotificationEl.className = `timer-notification ${type}`;

            // Auto-hide after duration based on type
            const duration = type === 'warning' ? 8000 : type === 'critical' ? 0 : 5000;
            if (duration > 0) {
                setTimeout(() => {
                    dismissNotification();
                }, duration);
            }
        }

        function dismissNotification() {
            timerNotificationEl.classList.add('hidden');
        }

        function handleSessionTimeout() {
            log('⏰ 對話時間已達 45 分鐘限制', 'warn');
            showTimerNotification('對話時間已達上限，正在結束對話...', 'critical');

            // Trigger graceful goodbye
            if (app && app.stateMachine.getState() !== 'STOPPED') {
                app.handleDirective('btn_goodbye');
            }
        }

        // ============================================
        // Connection Handlers
        // ============================================

        async function handleConnect() {
            if (!app) {
                log('錯誤：應用程式未初始化', 'error');
                return;
            }

            log('開始連線...', 'info');
            const success = await app.connect();

            if (!success) {
                log('連線失敗，請檢查設定和網路', 'error');
            }
        }

        function handleDisconnect() {
            if (app) {
                app.disconnect();
            }
        }

        function backToSetup() {
            if (app) {
                app.disconnect();
            }
            window.location.href = '/';
        }

        // ============================================
        // Button Rendering
        // Note: DEFAULT_BUTTONS is defined in app.js
        // ============================================

        /**
         * Load button configuration from localStorage or use defaults
         * @returns {Array} Array of button configurations
         */
        function loadButtonConfig() {
            const stored = localStorage.getItem('vpn_button_config');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        log('已載入自訂按鈕配置', 'info');
                        return parsed;
                    }
                } catch (e) {
                    log('按鈕配置解析失敗，使用預設值', 'warn');
                }
            }
            log('使用預設按鈕配置', 'info');
            return DEFAULT_BUTTONS;
        }

        /**
         * Render buttons dynamically into the button grid
         * @param {Array} buttons - Array of button configurations
         */
        function renderButtons(buttons) {
            const buttonGrid = document.getElementById('buttonGrid');
            buttonGrid.innerHTML = ''; // Clear existing buttons

            buttons.forEach((btnConfig, index) => {
                const button = document.createElement('button');
                button.className = btnConfig.buttonClass || 'btn-secondary';
                button.id = btnConfig.id;
                button.dataset.directive = btnConfig.id; // Use button id as directive
                button.dataset.executionType = btnConfig.executionType;
                button.textContent = btnConfig.label;

                // Store full config as data attribute for reference
                button.dataset.config = JSON.stringify({
                    promptTemplate: btnConfig.promptTemplate,
                    guidanceTemplate: btnConfig.guidanceTemplate,
                    executionType: btnConfig.executionType
                });

                buttonGrid.appendChild(button);
            });

            log(`已渲染 ${buttons.length} 個按鈕`, 'info');
        }

        /**
         * Attach event listeners to all rendered buttons
         */
        function attachButtonListeners() {
            document.querySelectorAll('#buttonGrid button').forEach(btn => {
                const directive = btn.dataset.directive;
                if (directive) {
                    btn.addEventListener('click', () => {
                        if (app) {
                            // Pass the button config along with the directive
                            const configStr = btn.dataset.config;
                            let config = null;
                            if (configStr) {
                                try {
                                    config = JSON.parse(configStr);
                                } catch (e) {
                                    // Ignore parse errors
                                }
                            }
                            app.handleDirective(directive, config);
                        }
                    });
                }
            });
        }

        // ============================================
        // Initialize
        // ============================================

        function init() {
            // Create application instance
            app = new VoiceProxyApp();

            // Wire up callbacks
            app.onLog = log;
            app.onStateChange = updateState;
            app.onConnectionChange = updateConnectionStatus;
            app.onMicChange = updateMicStatus;
            app.onSpeakerChange = updateSpeakerStatus;
            app.onNotesForUser = showNotesForUser;
            app.onTimerUpdate = updateSessionTimer;
            app.onTimerNotification = showTimerNotification;
            app.onSessionTimeout = handleSessionTimeout;

            // Load config
            if (!app.loadConfig()) {
                goalDisplay.textContent = '（未設定 - 請返回設定頁）';
                btnConnect.disabled = true;
                return;
            }

            // Display goal
            goalDisplay.textContent = app.config.goal || '（未設定）';

            // Log config summary
            log(`語音角色: ${app.config.voice}`, 'info');

            // Load and render buttons dynamically
            const buttonConfig = loadButtonConfig();
            renderButtons(buttonConfig);
            attachButtonListeners();

            // Initial state display
            stateText.textContent = app.stateMachine.getState();

            log('對話頁已載入', 'info');
            log('點擊「連線開始對話」開始', 'info');
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
